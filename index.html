<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <link rel="icon" href="favicon.png" type="image/png">
  <title>LUXU LIVE GAME</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="livegame.js"></script>
  <style>

  @media (max-width: 768px) {
  header {
    flex-direction: column;
    align-items: center;
    padding: 16px 10px;
  }

  .nav-buttons {
    flex-direction: column;
    align-items: stretch;
    gap: 10px;
    width: 100%;
    max-width: 300px;
    margin-top: 15px;
  }

  .nav-buttons > div {
    width: 100%;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .nav-buttons button,
  .nav-buttons a button,
  #logoutBtn {
    width: 100%;
    font-size: 16px;
    padding: 12px 0;
    border-radius: 10px;
  }

  h1 {
    font-size: 22px;
    text-align: center;
  }
}

    body {
  font-family: 'Inter', sans-serif;
  background: #fff;
  color: #222;
  margin: 0;
  padding: 0;
}
.dropdown {
  position: relative;
}

.dropdown-menu button {
  display: block;
  width: 100%;
  text-align: left;
  padding: 8px 12px;
  border: none;
  background: none;
  cursor: pointer;
}

.dropdown-menu button:hover {
  background: #eee;
}


header {
  background: #f9f9f9;
  padding: 12px 20px;
  border-bottom: 1px solid #ddd;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

header h1 {
  font-size: 20px;
  margin: 0;
  color: #111;
}
.nav-buttons {
  display: flex;
  flex-wrap: wrap;
  gap: 15px;
  align-items: center;
}

.nav-buttons > div {
  display: flex;
  gap: 2px;
}

.nav-buttons button,
.nav-buttons a button,
#logoutBtn {
  background: #473102b7;
  color: #fff;
  border: none;
  padding: 10px 16px;
  font-size: 14px;
  border-radius: 6px;
  cursor: pointer;
  min-width: 120px;
  text-align: center;
  transition: background 0.3s, transform 0.2s;
}

.nav-buttons button:hover,
#logoutBtn:hover {
  background: #333;
  transform: scale(1.03);
}


#loginBox {
  max-width: 360px;
  margin: 100px auto;
  padding: 24px;
  background: #fafafa;
  border: 1px solid #ddd;
  border-radius: 4px;
}

#loginBox h2 {
  text-align: center;
  font-size: 20px;
  margin-bottom: 16px;
}

input {
  background: white;
  color: white;
  border: 1px solid #444;
  transition: 0.3s;
  padding: 10px 10px;      /* ‡∏Ç‡∏¢‡∏≤‡∏¢‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á */
  font-size: 16px;         /* ‡∏Ç‡∏¢‡∏≤‡∏¢‡∏Ç‡∏ô‡∏≤‡∏î‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£ */
  width: 100%;             /* ‡πÉ‡∏´‡πâ‡∏ä‡πà‡∏≠‡∏á‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡πÄ‡∏ï‡πá‡∏° container */
  box-sizing: border-box;  /* ‡πÉ‡∏´‡πâ padding ‡πÑ‡∏°‡πà‡∏•‡πâ‡∏ô */
}


input:focus {
  outline: none;
  border-color: #00ffcc;
  background: #333;
}

button:hover {
  opacity: 0.85;
}


#popupOverlay {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(255,255,255,0.9);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 1000;
}

#popupBox {
  background: #fff;
  border: 1px solid #ccc;
  padding: 20px;
  width: 90%;
  max-width: 360px;
  border-radius: 4px;
}

#popupBox h3 {
  margin-top: 0;
}

#popupBox button {
  padding: 6px 12px;
  border: 1px solid #222;
  background: transparent;
  cursor: pointer;
  margin-right: 10px;
  margin-top: 5px;
}

.game-header {
  max-width: 900px;
  margin: 30px auto 10px;
  font-size: 14px;
  color: #333;
  border-bottom: 1px solid #ccc;
  padding-bottom: 4px;
}

.game-table {
  width: 90%;
  margin: 0 auto;
  border-collapse: collapse;
  font-size: 14px;
}

.game-table th, .game-table td {
  border: 1px solid #ddd;
  padding: 10px;
  text-align: center;
}

.game-table th {
  background: #f3f3f3;
}

.game-table button {
  transition: background 0.3s, transform 0.2s;
}

.game-table button:hover {
  background: #00ddaa;
  transform: scale(1.05);
}
.buyin-history {
      font-size: 14px;
      text-align: center;
      margin-bottom: 5px;
    }

.dropdown-menu button {
  display: block;
  padding: 8px 10px;
  width: 100%;
  border: none;
  background: none;
  cursor: pointer;
  border-radius: 4px;
}

.dropdown-menu button:hover {
  background-color: #6d5106;
}

  </style>
</head>
<body>

<header>
  <h1>LUXU LIVE GAME</h1>
  
  <div class="nav-buttons" id="navButtons">
  <div>
    <a href="ranking.html" target="_blank"><button>üèÜ All Time Money</button></a>
  </div>
  <div>
    <button onclick="window.location.href='accounting.html'">Accounting</button>
    <button onclick="window.location.href='rake.html'">üé∞ Rake</button>
    <button onclick="addGame()">+Game</button>
    <button onclick="loadGameHistory()">üìú Game History</button>
  </div>
  <div>
  <div class="dropdown" id="memberDropdown" style="position: relative;">
  <button onclick="toggleMemberMenu()">Member</button>
  <div id="memberMenu" class="dropdown-menu" style="display:none; position:absolute; right:0; background:#fff; border:1px solid #ccc; padding:10px; border-radius:6px; box-shadow:0 4px 12px rgba(0,0,0,0.1); z-index:1000; min-width:200px;">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
      <strong style="font-size:14px;">Members Management</strong>
      <button onclick="closeMemberMenu()" style="border:none; background:none; font-size:16px; cursor:pointer;color: red;text-align: right;">‚úñ</button>
    </div>
    <button onclick="openAddMember()" style="width:100%; text-align:left;color: black;">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÉ‡∏´‡∏°‡πà</button>
    <button onclick="openManageMember()" style="width:100%; text-align:left;color: black;">üë• ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Member</button>
  </div>
</div>



    <button onclick="generatePlayerReport()">PlayerReport</button>
  </div>
  <div>
    <button id="logoutBtn" onclick="logout()">Logout</button>
  </div>
</div>
</header>

<div id="loginBox">
  <h2>Admin Login</h2>
  <input type="email" id="email" placeholder="Email" />
  <input type="password" id="password" placeholder="Password" />
  <button onclick="login()">Login</button>
</div>

<div id="popupOverlay">
  <div id="popupBox">
    <h3>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÉ‡∏´‡∏°‡πà</h3>
    <input type="text" id="memberName" placeholder="Name : required" required>
    <input type="text" id="memberTel" placeholder="Tel : (optional)">
    <input type="email" id="memberEmail" placeholder="Email : (optional)">
    <div>
      <button onclick="confirmAddMember()">Confirm</button>
      <button onclick="closePopup()">Cancel</button>
    </div>
  </div>
</div>
<div id="gameContainer"></div>
<!-- Popup ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô -->
<div id="playerSelectOverlay" style="display:none; position:fixed; inset:0; background:#fffdfdcb; z-index:9999; justify-content:center; align-items:center;">
  <div style="background:#fff; padding:20px; border:1px solid #ccc; width:300px;">
    <h3>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô</h3>
    <input type="text" id="searchMember" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤" style="width:100%; margin-bottom:10px;">
    <div id="memberList" style="max-height:200px; overflow-y:auto; border:1px solid #ddd;"></div>
    <div style="margin-top:10px; text-align:right;">
      <button onclick="closePlayerPopup()">Cancel</button>
    </div>
  </div>
</div>
<!-- Player Report Popup -->
<div id="reportOverlay" style="display:none; position:fixed; inset:0; background:rgba(245, 230, 230, 0.3); z-index:9999; justify-content:center; align-items:center; text-align: center;">
  <div style="background:#fff; padding:24px 28px; max-width:700px; width:90%; border-radius:10px; box-shadow:0 8px 24px rgba(0,0,0,0.2); font-family:'Inter', sans-serif;">
    <h2 style="margin-top:0; font-size:18px; color:#222; margin-bottom:16px;">Player Report</h2>

    <div style="display:flex; flex-wrap:wrap; gap:10px; margin-bottom:14px;">
      <label style="flex:1; font-size:13px; color:#141212;">
        ‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà:
        <input type="date" id="startDate" style="width:100%; padding:6px 8px; border:1px solid #ccc; border-radius:4px; background:white;color: #111;">
      </label>
      <label style="flex:1; font-size:13px; color:#141212;">
        ‡∏ñ‡∏∂‡∏á:
        <input type="date" id="endDate" style="width:100%; padding:6px 8px; border:1px solid #ccc; border-radius:4px;background:white;color:#111;">
      </label>
      <div style="display:flex; align-items:end;">
        <button onclick="generatePlayerReport()" style="padding:8px 14px; background:#007bff; color:#fff; border:none; border-radius:5px; cursor:pointer;">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
      </div>
    </div>

    <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:12px;">
      <select id="reportFilter" onchange="generatePlayerReport()" style="padding:6px 8px; border:1px solid #ccc; border-radius:4px;">
        <option value="all">‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
        <option value="day">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</option>
        <option value="week">‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ô‡∏µ‡πâ</option>
        <option value="month">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</option>
      </select>

      <select id="filterMember" style="padding:6px 8px; border:1px solid #ccc; border-radius:4px;">
        <option value="">-- ‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô --</option>
      </select>

      <input type="text" id="searchName" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠..." oninput="generatePlayerReport()" style="flex:1; padding:6px 10px; border:1px solid #ccc; border-radius:4px;">
    </div>

    <div style="overflow-x:auto; max-height:300px;">
      <table style="width:100%; border-collapse:collapse; font-size:14px;">
        <thead style="background:#f2f2f2;">
  <tr>
    <th style="padding:8px; border:1px solid #ddd;">Date</th>
    <th style="padding:8px; border:1px solid #ddd;">Name</th>
    <th style="padding:8px; border:1px solid #ddd;">Total Buy-in</th>
    <th style="padding:8px; border:1px solid #ddd;">Total Cash-out</th>
    <th style="padding:8px; border:1px solid #ddd;">Profit</th>
    
  </tr>
</thead>

        <tbody id="reportBody"></tbody>
      </table>
    </div>

    <div style="text-align:right; margin-top:14px;">
      <button onclick="document.getElementById('reportOverlay').style.display='none'" style="padding:8px 14px; background:#ccc; color:#333; border:none; border-radius:5px; cursor:pointer;">Close</button>
    </div>
  </div>
</div>

<!-- Manage Player Popup -->
<div id="managePlayerOverlay" style="display:none; position:fixed; inset:0; background:#ffffffee; z-index:9999; justify-content:center; align-items:flex-start; padding-top:50px;text-align: center;">
  <div style="background:#fff; padding:20px; width:90%; max-width:600px; border:1px solid #ccc; border-radius:6px;">
    <h3>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô</h3>
    <table style="width:100%; border-collapse:collapse; font-size:14px;" border="1">
      <thead>
        <tr>
          <th>‡∏ä‡∏∑‡πà‡∏≠</th>
          <th>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</th>
          <th>Email</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="managePlayerBody"></tbody>
    </table>
    <div style="text-align:right; margin-top:10px;">
      <button onclick="document.getElementById('managePlayerOverlay').style.display='none'">Close</button>
    </div>
  </div>
</div>

<!-- Edit Player Popup -->
<div id="editPlayerOverlay" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.3); z-index:10001; justify-content:center; align-items:center;">
  <div style="background:#fff; padding:24px 28px; width:90%; max-width:400px; border-radius:10px; box-shadow:0 8px 24px rgba(0,0,0,0.2); font-family:'Inter', sans-serif;">
    <h2 style="margin-top:0; margin-bottom:16px; font-size:18px; color:#222;">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô</h2>

    <div style="margin-bottom:12px;">
      <label for="editName" style="display:block; font-size:13px; color:#555; margin-bottom:4px;">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô</label>
      <input type="text" id="editName" style="width:100%; padding:8px 10px; border:1px solid #cccccc; border-radius:5px;background-color: #464242;" />
    </div>

    <div style="margin-bottom:12px;">
      <label for="editTel" style="display:block; font-size:13px; color:#555; margin-bottom:4px;">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</label>
      <input type="text" id="editTel" style="width:100%; padding:8px 10px; border:1px solid #ccc; border-radius:5px;background-color: #464242;" />
    </div>

    <div style="margin-bottom:20px;">
      <label for="editEmail" style="display:block; font-size:13px; color:#555; margin-bottom:4px;">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
      <input type="email" id="editEmail" style="width:100%; padding:8px 10px; border:1px solid #ccc; border-radius:5px;background-color: #464242;" />
    </div>

    <div style="text-align:right;">
      <button onclick="saveEditPlayer()" style="padding:8px 16px; background:#007bff; color:#fff; border:none; border-radius:5px; margin-right:8px; cursor:pointer;">Save</button>
      <button onclick="closeEditPlayer()" style="padding:8px 16px; background:#ccc; color:#333; border:none; border-radius:5px; cursor:pointer;">Cancel</button>
    </div>
  </div>
</div>
<div id="manageMemberOverlay" style="display:none; position:fixed; inset:0; background:#ffffffcc; z-index:9999; justify-content:center; align-items:center;">
  <div style="background:#fff; padding:20px; width:90%; max-width:500px; border-radius:8px; box-shadow:0 6px 20px rgba(0,0,0,0.2);">
    <h3 style="margin-top:0;">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤/‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</h3>
    <input type="text" id="searchMemberManage" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å..." style="width:100%; padding:8px; margin-bottom:10px; border:1px solid #ccc; border-radius:5px;">
    
    <div id="manageMemberList" style="max-height:300px; overflow-y:auto; border-top:1px solid #ddd;"></div>

    <div style="text-align:right; margin-top:10px;">
      <button onclick="closeManageMember()" style="padding:6px 14px; background:#ccc; border:none; border-radius:5px;">‡∏õ‡∏¥‡∏î</button>
    </div>
  </div>
</div>
<div id="historySearchBox" style="margin: 20px auto; padding: 15px; background: #f9f9f9; border-radius: 12px; border: 1px solid #ccc; max-width: 800px;">
  <h3 style="margin-top: 0;">üìÖ ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÄ‡∏Å‡∏°‡∏ó‡∏µ‡πà‡∏õ‡∏¥‡∏î‡πÅ‡∏•‡πâ‡∏ß (Game Break)</h3>
  
  <div style="display: flex; flex-wrap: wrap; gap: 10px; align-items: center; margin-top: 10px;">
    <label>‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà: 
      <input type="date" id="historyStartDate" style="padding: 5px; border-radius: 6px; border: 1px solid #ccc;color:#7d8180;">
    </label>
    <label>‡∏ñ‡∏∂‡∏á: 
      <input type="date" id="historyEndDate" style="padding: 5px; border-radius: 6px; border: 1px solid #ccc;color:#7d8180;">
    </label>

    <button onclick="searchGameHistory()" style="padding: 6px 12px; border: none; background: #4CAF50; color: white; border-radius: 6px; cursor: pointer;">
      üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
    </button>
    <button onclick="presetHistoryDays(7)" style="padding: 6px 12px; border: none; background: #2196F3; color: white; border-radius: 6px; cursor: pointer;">
      ‚è≥ 7 ‡∏ß‡∏±‡∏ô
    </button>
    <button onclick="presetHistoryDays(30)" style="padding: 6px 12px; border: none; background: #03A9F4; color: white; border-radius: 6px; cursor: pointer;">
      üìÜ 30 ‡∏ß‡∏±‡∏ô
    </button>
    <button onclick="searchGameHistory(true)" style="padding: 6px 12px; border: none; background: #9E9E9E; color: white; border-radius: 6px; cursor: pointer;">
      üóÇÔ∏è ‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    </button>
  </div>
</div>

<div id="historyContainer" style="padding: 20px; max-width: 800px; margin: auto;"></div>





<script>
  const app = firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();
  

  function login() {
    const email = document.getElementById("email").value.trim();
    const password = document.getElementById("password").value.trim();
    auth.signInWithEmailAndPassword(email, password)
      .then(() => {
        document.getElementById("loginBox").style.display = "none";
        document.getElementById("navButtons").style.display = "flex";
        document.getElementById("logoutBtn").style.display = "inline-block";
        loadGames();
      })
      .catch(error => {
        alert("Login failed: " + error.message);
      });
  }

  function logout() {
    auth.signOut().then(() => {
      location.reload();
    });
  }

  auth.onAuthStateChanged(user => {
    if (user) {
      document.getElementById("loginBox").style.display = "none";
      document.getElementById("navButtons").style.display = "flex";
      document.getElementById("logoutBtn").style.display = "inline-block";
      loadGames();
    }
  });

  function addMember() {
    document.getElementById("popupOverlay").style.display = "flex";
  }

  function closePopup() {
    document.getElementById("popupOverlay").style.display = "none";
    document.getElementById("memberName").value = "";
    document.getElementById("memberTel").value = "";
    document.getElementById("memberEmail").value = "";
  }

  async function confirmAddMember() {
    const name = document.getElementById("memberName").value.trim();
    const tel = document.getElementById("memberTel").value.trim();
    const email = document.getElementById("memberEmail").value.trim();

    if (!name) {
      alert("Please fill in required fields.");
      return;
    }

    const existing = await db.collection("members").where("name", "==", name).get();
    if (!existing.empty) {
      alert("This name already exists.");
      return;
    }

    const newRef = db.collection("members").doc();
    await newRef.set({
      id: newRef.id,
      name,
      tel,
      email,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    alert("Member added successfully");
    closePopup();
  }

  // ‡πÉ‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á <script> ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå livegame.js
async function addGame() {
  // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á popup ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
  if (!confirm("‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏Å‡∏°‡πÉ‡∏´‡∏°‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) {
    return; // ‡∏ñ‡πâ‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏Å‡∏î Cancel, ‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£‡∏ï‡πà‡∏≠
  }

  const gameRef = db.collection("games").doc();
  const now = new Date();
  await gameRef.set({
    id: gameRef.id,
    status: "Running",
    createdAt: firebase.firestore.Timestamp.fromDate(now)
  });
  loadGames();
}

  async function loadGames() {
    const container = document.getElementById("gameContainer");
    container.innerHTML = "";
    const snapshot = await db.collection("games").where("status", "==", "Running").get();
    snapshot.forEach(doc => renderGameTable(doc.data()));
  }

async function renderGameTable(game) {
  const wrapper = document.createElement("div");
  wrapper.className = "game-wrapper";

  // ‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á
  const header = document.createElement("div");
  header.className = "game-header";
  const created = new Date(game.createdAt.seconds * 1000).toLocaleString();
  header.innerHTML = `
  <strong>${created}</strong> :<strong style="color:green;"> ${game.status} </strong>: 
  <button class="toggle-btn" onclick="this.parentElement.nextElementSibling.style.display = this.parentElement.nextElementSibling.style.display === 'none' ? '' : 'none'">Show/Hide</button>
  <button class="toggle-btn" onclick="breakGame('${game.id}')">Break</button>
  <button class="toggle-btn" onclick="deleteGame('${game.id}')">Delete</button>
  <p style="color:red;text-decoration: underline;font-weight: bold;">* ‡∏Å‡∏î Cash out ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö ‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏î Break ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏à‡∏ö‡πÄ‡∏Å‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏¥‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á *</p>
`;

  // ‡∏ï‡∏≤‡∏£‡∏≤‡∏á
  const table = document.createElement("table");
  table.className = "game-table";
  const thead = document.createElement("thead");
  thead.innerHTML = `
  <tr>
    <th>Name</th>
    <th>Buy-in</th>
    <th>Cash-out</th>
    <th>Total</th>
    <th>Delete</th>
  </tr>
`;



  const tbody = document.createElement("tbody");

  // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• players
  const playerSnap = await db.collection("games").doc(game.id).collection("players").orderBy("createdAt").get();
  const players = [];
  playerSnap.forEach(doc => players.push(doc.data()));

  for (let i = 0; i < 10; i++) {
    const tr = document.createElement("tr");

    // ‡∏ä‡πà‡∏≠‡∏á Name
    const tdName = document.createElement("td");
    if (players[i]) {
      tdName.textContent = players[i].name;
    } else {
      const btn = document.createElement("button");
      btn.textContent = "+Player";
      btn.onclick = () => openPlayerPopup(game.id, tr);
      tdName.appendChild(btn);
    }
    tr.appendChild(tdName);

    // Buy-in
    const tdBuyin = document.createElement("td");
    if (players[i]) {
      renderBuyins(game.id, players[i].id, tdBuyin);
    } else {
      const btnBuy = document.createElement("button");
      btnBuy.textContent = "Buy-in";
      btnBuy.disabled = true;
      tdBuyin.appendChild(btnBuy);
    }
    tr.appendChild(tdBuyin);

    // Cash-out
    const tdCash = document.createElement("td");
    const tdTotal = document.createElement("td"); // ‡∏ä‡πà‡∏≠‡∏á Total ‡∏Ñ‡∏ß‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
    if (players[i]) {
      const cash = players[i].cashout;
      if (cash) {
        const time = players[i].cashoutAt?.seconds
          ? new Date(players[i].cashoutAt.seconds * 1000).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
          : "-";
        tdCash.textContent = `${cash} @ ${time}`;
      } else {
        const btnCash = document.createElement("button");
        btnCash.textContent = "Cash-out";
        btnCash.onclick = () => openCashoutPopup(game.id, players[i].id, tdCash, tdTotal);
        tdCash.appendChild(btnCash);
      }

      // ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Total
      updateTotal(game.id, players[i].id, tdTotal);
    } else {
      const btnCash = document.createElement("button");
      btnCash.textContent = "Cash-out";
      btnCash.disabled = true;
      tdCash.appendChild(btnCash);
    }
    tr.appendChild(tdCash);

    // Total (‡∏ä‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏ú‡∏π‡∏Å‡∏Å‡∏±‡∏ö tdTotal ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô)
    tr.appendChild(tdTotal);




    // Delete
    const tdDel = document.createElement("td");
    const btnDel = document.createElement("button");
    btnDel.textContent = "Delete";
if (players[i]) {
  btnDel.onclick = () => handleDeletePlayer(game.id, players[i].id, tr);
}
    tdDel.appendChild(btnDel);
    tr.appendChild(tdDel);

    tbody.appendChild(tr);
  }

  table.appendChild(thead);
  table.appendChild(tbody);
  wrapper.appendChild(header);
  wrapper.appendChild(table);
  document.getElementById("gameContainer").appendChild(wrapper);
}



// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ã‡πà‡∏≠‡∏ô/‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á
function toggleTable(btn) {
  const table = btn.parentElement.nextElementSibling;
  if (table.style.display === "none") {
    table.style.display = "";
  } else {
    table.style.display = "none";
  }
}

let currentGameId = null;
let currentRow = null;

function closePlayerPopup() {
  document.getElementById("playerSelectOverlay").style.display = "none";
  document.getElementById("searchMember").value = "";
  document.getElementById("memberList").innerHTML = "";
  currentGameId = null;
  currentRow = null;
}

async function openPlayerPopup(gameId, rowElement) {
  currentGameId = gameId;
  currentRow = rowElement;
  document.getElementById("playerSelectOverlay").style.display = "flex";
  loadMembers("");
}

document.getElementById("searchMember").addEventListener("input", e => {
  loadMembers(e.target.value.toLowerCase());
});

async function loadMembers(query) {
  const snap = await db.collection("members").orderBy("name").get();
  const container = document.getElementById("memberList");
  container.innerHTML = "";
  snap.forEach(doc => {
    const data = doc.data();
    data.id = doc.id; // ‚úÖ ‡πÉ‡∏™‡πà id ‡∏•‡∏á‡πÉ‡∏ô object ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ
    if (!query || data.name.toLowerCase().includes(query)) {
      const div = document.createElement("div");
      div.textContent = data.name;
      div.style.padding = "5px";
      div.style.cursor = "pointer";
      div.style.borderBottom = "1px solid #eee";
      div.onclick = () => selectMemberForGame(data); // ‚úÖ data ‡∏°‡∏µ id ‡πÅ‡∏•‡πâ‡∏ß
      container.appendChild(div);
    }
  });
}



// ‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï selectMemberForGame() ‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏µ‡πà sit-out ‡πÅ‡∏•‡πâ‡∏ß‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ (‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥)
async function selectMemberForGame(member) {
  if (!currentGameId || !currentRow) return;

  // ‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏â‡∏û‡∏≤‡∏∞ players collection
  const snap = await db.collection("games").doc(currentGameId).collection("players")
    .where("memberId", "==", member.id)
    .get();

  if (!snap.empty) {
    alert("‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÄ‡∏Å‡∏°‡πÅ‡∏•‡πâ‡∏ß");
    return;
  }

  const playerRef = db.collection("games").doc(currentGameId).collection("players").doc();
  await playerRef.set({
    id: playerRef.id,
    memberId: member.id,
    name: member.name,
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  });

  currentRow.children[0].innerText = member.name;
  closePlayerPopup();
  loadGames();
}
// ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏∏‡πà‡∏° Buy-in ‡πÉ‡∏´‡πâ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
function openBuyinPopup(gameId, playerId, tdElement) {
  const amount = prompt("Enter Buy-in amount:");
  if (!amount || isNaN(amount)) return alert("Invalid amount");

  const buyinRef = db.collection("games").doc(gameId)
    .collection("players").doc(playerId)
    .collection("buyins").doc();

  buyinRef.set({
    id: buyinRef.id,
    amount: parseInt(amount),
    createdAt: firebase.firestore.Timestamp.now()
  }).then(() => {
    renderBuyins(gameId, playerId, tdElement); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
  });
}

async function renderBuyins(gameId, playerId, tdElement) {
  const snap = await db.collection("games").doc(gameId)
    .collection("players").doc(playerId)
    .collection("buyins").orderBy("createdAt").get();

  tdElement.innerHTML = "";
  let count = 1;

  snap.forEach(doc => {
    const data = doc.data();
    let time = "-";
    if (data.createdAt?.seconds) {
      time = new Date(data.createdAt.seconds * 1000).toLocaleTimeString([], {
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    const line = document.createElement("div");
    line.className = "buyin-history";
    line.textContent = `x${count}, ${data.amount}, ${time}`;
    tdElement.appendChild(line);
    count++;
  });

  const btn = document.createElement("button");
  btn.textContent = "Buy-in";
  btn.onclick = () => openBuyinPopup(gameId, playerId, tdElement);
  tdElement.appendChild(btn);
}

// ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° popup ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Cash-out
function openCashoutPopup(gameId, playerId, tdElement) {
  const amount = prompt("Enter Cash-out amount:");
  if (!amount || isNaN(amount)) return alert("Invalid amount");

  const playerDoc = db.collection("games").doc(gameId).collection("players").doc(playerId);

  playerDoc.get().then(doc => {
    if (doc.exists && doc.data().cashout) {
      alert("Cash-out already submitted.");
      return;
    }

playerDoc.update({
  cashout: parseInt(amount),
  cashoutAt: firebase.firestore.Timestamp.now()
}).then(async () => {
  const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  tdElement.innerHTML = `${amount} @ ${time}`;

  const playerSnap = await playerDoc.get();
  const playerData = playerSnap.data();

  // ‡∏î‡∏∂‡∏á buyins
  const buyinSnap = await playerDoc.collection("buyins").get();
  let totalBuyin = 0;
  buyinSnap.forEach(doc => totalBuyin += doc.data().amount || 0);

  const total = playerData.cashout - totalBuyin;

  // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å sitout ‡∏ï‡πà‡∏≠‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°
  const row = tdElement.parentElement;
  handleSitOut(gameId, playerId, row);
});

});
}
// ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Total = cashout - buyin ‡∏£‡∏ß‡∏°
function updateTotal(gameId, playerId, tdTotal) {
  const playerDoc = db.collection("games").doc(gameId).collection("players").doc(playerId);
  const buyinCol = playerDoc.collection("buyins");

  Promise.all([
    playerDoc.get(),
    buyinCol.get()
  ]).then(([playerSnap, buyinSnap]) => {
    const cashout = playerSnap.data().cashout || 0;
    let totalBuyin = 0;
    buyinSnap.forEach(doc => totalBuyin += doc.data().amount);
    const total = cashout - totalBuyin;

    tdTotal.textContent = total;
    playerDoc.update({ total });
  });
}

async function handleSitOut(gameId, playerId, trElement) {
  const playerRef = db.collection("games").doc(gameId).collection("players").doc(playerId);
  const playerSnap = await playerRef.get();
  if (!playerSnap.exists) return;
  const playerData = playerSnap.data();

  const buyinSnap = await db.collection("games").doc(gameId)
    .collection("players").doc(playerId).collection("buyins").orderBy("createdAt").get();

  const buyins = [];
  let totalBuyin = 0;
  buyinSnap.forEach(doc => {
    const data = doc.data();
    buyins.push(data);
    totalBuyin += data.amount;
  });

  if (playerData.cashout === undefined) {
    playerData.cashout = 0;
    playerData.cashoutAt = firebase.firestore.Timestamp.now();
  }

  const total = playerData.cashout - totalBuyin;
  playerData.total = total;

  const movedAt = firebase.firestore.Timestamp.now();

  const sitOutRef = db.collection("games").doc(gameId).collection("sitout").doc();
  await sitOutRef.set({
    ...playerData,
    sitOutId: sitOutRef.id,
    movedAt,
    buyins
  });
  // (‡∏•‡∏ö‡∏≠‡∏≠‡∏Å) ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å sitoutLogs ‡πÉ‡∏ô members ‡∏≠‡∏µ‡∏Å‡∏ï‡πà‡∏≠‡πÑ‡∏õ

  await playerRef.delete();
  loadGames();

  // Reset UI
  trElement.innerHTML = "";
  const tdName = document.createElement("td");
  const btn = document.createElement("button");
  btn.textContent = "+Player";
  btn.onclick = () => openPlayerPopup(gameId, trElement);
  tdName.appendChild(btn);
  trElement.appendChild(tdName);

  for (let i = 0; i < 5; i++) {
    const td = document.createElement("td");
    const disabledBtn = document.createElement("button");
    disabledBtn.textContent = ["Buy-in", "Cash-out", "", "Sit-out", "Delete"][i];
    disabledBtn.disabled = true;
    td.appendChild(disabledBtn);
    trElement.appendChild(td);
  }
}
async function handleDeletePlayer(gameId, playerId, trElement) {
  if (!confirm("Are you sure you want to delete this player and all their data?")) return;

  const playerRef = db.collection("games").doc(gameId).collection("players").doc(playerId);
  const buyinSnap = await playerRef.collection("buyins").get();

  const batch = db.batch();
  buyinSnap.forEach(doc => {
    batch.delete(doc.ref); // ‚úÖ ‡∏•‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞ buyin document
  });
  batch.delete(playerRef); // ‚úÖ ‡∏•‡∏ö‡∏ï‡∏±‡∏ß player document ‡∏î‡πâ‡∏ß‡∏¢

  await batch.commit(); // ‚úÖ ‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏à‡∏£‡∏¥‡∏á
  loadGames(); // ‚úÖ ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á

  // ‡∏•‡πâ‡∏≤‡∏á‡πÅ‡∏ñ‡∏ß UI ‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏™‡πà‡∏õ‡∏∏‡πà‡∏° +Player ‡∏Å‡∏•‡∏±‡∏ö
  trElement.innerHTML = "";
  const tdName = document.createElement("td");
  const btn = document.createElement("button");
  btn.textContent = "+Player";
  btn.onclick = () => openPlayerPopup(gameId, trElement);
  tdName.appendChild(btn);
  trElement.appendChild(tdName);

  for (let i = 0; i < 5; i++) {
    const td = document.createElement("td");
    const disabledBtn = document.createElement("button");
    disabledBtn.textContent = ["Buy-in", "Cash-out", "", "Sit-out", "Delete"][i];
    disabledBtn.disabled = true;
    td.appendChild(disabledBtn);
    trElement.appendChild(td);
  }
}


async function deleteGame(gameId) {
  const confirmDelete = confirm("‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÄ‡∏Å‡∏°‡∏ô‡∏µ‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?");
  if (!confirmDelete) return;

  const gameRef = db.collection("games").doc(gameId);

  // üî• 1. ‡∏•‡∏ö buyins ‡∏Ç‡∏≠‡∏á‡∏ó‡∏∏‡∏Å player
  const players = await gameRef.collection("players").get();
  for (const player of players.docs) {
    const buyinSnap = await player.ref.collection("buyins").get();
    for (const buyin of buyinSnap.docs) {
      await buyin.ref.delete();
    }
  }

  // üî• 2. ‡∏•‡∏ö players
  for (const player of players.docs) {
    await player.ref.delete();
  }

  // üî• 3. ‡∏•‡∏ö sitout
  const sitoutSnap = await gameRef.collection("sitout").get();
  for (const doc of sitoutSnap.docs) {
    await doc.ref.delete();
  }

  // üî• 4. ‡∏•‡∏ö‡∏ï‡∏±‡∏ß‡πÄ‡∏Å‡∏°‡∏´‡∏•‡∏±‡∏Å
  await gameRef.delete();

  alert("‡∏•‡∏ö‡πÄ‡∏Å‡∏°‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß");
  location.reload();
}



async function breakGame(gameId) {
  if (!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£ Break ‡πÄ‡∏Å‡∏°?")) return;

  const gameRef = db.collection("games").doc(gameId);

  // ‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏Å‡∏°‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
  await gameRef.update({ status: "Game Break" });

  alert("Break Game ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
  location.reload();
}



function getTimeFilterRange() {
  const startDateStr = document.getElementById("startDate")?.value;
  const endDateStr = document.getElementById("endDate")?.value;
  const filterType = document.getElementById("reportFilter")?.value || "all";

  let startTime = null;
  let endTime = null;

  if (startDateStr || endDateStr) {
    // ‚úÖ ‡πÉ‡∏ä‡πâ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å
    startTime = startDateStr ? new Date(startDateStr).getTime() : null;
    endTime = endDateStr ? new Date(endDateStr + "T23:59:59").getTime() : null;
  } else {
    // üïí fallback: ‡πÉ‡∏ä‡πâ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏£‡∏π‡∏õ
    const now = new Date();
    switch (filterType) {
      case "day":
        startTime = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
        break;
      case "week":
        const dayOfWeek = now.getDay(); // Sunday = 0
        startTime = new Date(now.getFullYear(), now.getMonth(), now.getDate() - dayOfWeek).getTime();
        break;
      case "month":
        startTime = new Date(now.getFullYear(), now.getMonth(), 1).getTime();
        break;
      default:
        // "all" = ‡πÑ‡∏°‡πà‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏ß‡∏•‡∏≤
        startTime = null;
    }
  }

  return { startTime, endTime };
}

async function generatePlayerReport() {
  const nameQuery = document.getElementById("searchName")?.value.trim().toLowerCase() || "";
  const { startTime, endTime } = getTimeFilterRange();
  const tbody = document.getElementById("reportBody");

  const noFilters =
    !nameQuery &&
    !document.getElementById("startDate")?.value &&
    !document.getElementById("endDate")?.value &&
    (document.getElementById("reportFilter")?.value === "all");

  if (noFilters) {
    tbody.innerHTML = "";
    document.getElementById("reportOverlay").style.display = "flex";
    return;
  }

  tbody.innerHTML = "";

  const memberNameMap = await buildMemberNameMap();
  const reportMap = new Map(); // dateStr -> memberId -> summary

  const gamesSnap = await db.collection("games").get();

  for (const gameDoc of gamesSnap.docs) {
    const gameData = gameDoc.data();
    const createdAt = gameData.createdAt?.toDate?.() || null;
    if (!createdAt) continue;

    const gameTime = createdAt.getTime();
    if ((startTime && gameTime < startTime) || (endTime && gameTime > endTime)) continue;

    const dateStr = createdAt.toISOString().split("T")[0];
    const sitoutSnap = await db.collection("games").doc(gameDoc.id).collection("sitout").get();

    sitoutSnap.forEach(playerDoc => {
      const p = playerDoc.data();
      const memberId = p.memberId;
      const playerName = memberNameMap.get(memberId) || "Unknown";

      if (nameQuery && !playerName.toLowerCase().includes(nameQuery)) return;

      if (!reportMap.has(dateStr)) reportMap.set(dateStr, new Map());
      const memberMap = reportMap.get(dateStr);

      if (!memberMap.has(memberId)) {
        memberMap.set(memberId, {
          name: playerName,
          sumBuyin: 0,
          cashout: 0,
          profit: 0
        });
      }

      const entry = memberMap.get(memberId);
      const buyin = Array.isArray(p.buyins)
        ? p.buyins.reduce((sum, b) => sum + (b.amount || 0), 0)
        : (p.buyin || 0);
      const cashout = p.cashout || 0;
      const profit = p.total || (cashout - buyin);

      entry.sumBuyin += buyin;
      entry.cashout += cashout;
      entry.profit += profit;
    });
  }

  const sortedDates = Array.from(reportMap.keys()).sort((a, b) => {
    return new Date(b).getTime() - new Date(a).getTime();
  });

  sortedDates.forEach(dateStr => {
    const headerRow = document.createElement("tr");
    headerRow.innerHTML = `<td colspan="5" style="background:#f0f0f0;"><strong>üìÖ ${dateStr}</strong></td>`;
    tbody.appendChild(headerRow);

    const memberMap = reportMap.get(dateStr);
    const rows = Array.from(memberMap.values()).sort((a, b) => b.profit - a.profit);

    rows.forEach(row => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${dateStr}</td>
        <td>${row.name}</td>
        <td>${row.sumBuyin}</td>
        <td>${row.cashout}</td>
        <td style="color:${row.profit >= 0 ? 'green' : 'red'}">${row.profit}</td>
      `;
      tbody.appendChild(tr);
    });
  });

  document.getElementById("reportOverlay").style.display = "flex";
}





async function loadReportMemberList() {
  const select = document.getElementById("filterMember");
  if (!select) return;

  const snap = await db.collection("members").orderBy("name").get();
  select.innerHTML = `<option value="">-- ‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô --</option>`;
  snap.forEach(doc => {
    const data = doc.data();
    select.innerHTML += `<option value="${doc.id}">${data.name}</option>`;
  });
}
function openManagePlayer() {
  alert("‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô (‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏£‡∏¥‡∏á)");
  // ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô redirect ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà ‡πÄ‡∏ä‡πà‡∏ô
  // window.location.href = 'manageplayer.html';
}

function openManagePlayer() {
  document.getElementById("managePlayerOverlay").style.display = "flex";
  loadAllPlayers();
}

async function loadAllPlayers() {
  const container = document.getElementById("managePlayerBody");
  container.innerHTML = "";

  const snap = await db.collection("members").orderBy("name").get();
  snap.forEach(doc => {
    const data = doc.data();
    const tr = document.createElement("tr");

    tr.innerHTML = `
      <td>${data.name}</td>
      <td>${data.tel || '-'}</td>
      <td>${data.email || '-'}</td>
      <td>
        <button onclick="editPlayer('${doc.id}')">Edit</button>
        <button onclick="deletePlayer('${doc.id}', '${data.name}')">Delete</button>
      </td>
    `;

    container.appendChild(tr);
  });
}

function editPlayer(id) {
  alert("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏° Edit\nPlayer ID: " + id);
  // TODO: ‡πÄ‡∏õ‡∏¥‡∏î popup ‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô
}

async function deletePlayer(id, name) {
  const confirmDelete = confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô "${name}" ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`);
  if (!confirmDelete) return;

  await db.collection("members").doc(id).delete();
  alert("‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÅ‡∏•‡πâ‡∏ß");
  loadAllPlayers();
}

let currentEditPlayerId = null;

async function editPlayer(id) {
  currentEditPlayerId = id;

  const doc = await db.collection("members").doc(id).get();
  const data = doc.data();

  document.getElementById("editName").value = data.name || "";
  document.getElementById("editTel").value = data.tel || "";
  document.getElementById("editEmail").value = data.email || "";

  // ‚úÖ ‡∏ã‡πà‡∏≠‡∏ô popup ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏Å‡πà‡∏≠‡∏ô
  document.getElementById("manageMemberOverlay").style.display = "none";

  // ‚úÖ ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡πÅ‡∏™‡∏î‡∏á popup edit
  document.getElementById("editPlayerOverlay").style.display = "flex";
}


function closeEditPlayer() {
  document.getElementById("editPlayerOverlay").style.display = "none";
  currentEditPlayerId = null;
}

async function saveEditPlayer() {
  const name = document.getElementById("editName").value.trim();
  const tel = document.getElementById("editTel").value.trim();
  const email = document.getElementById("editEmail").value.trim();

  if (!name) {
    alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠");
    return;
  }

  await db.collection("members").doc(currentEditPlayerId).update({
    name, tel, email
  });

  alert("‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß");
  closeEditPlayer();
  loadAllPlayers(); // ‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà

}
function toggleMemberMenu() {
  const menu = document.getElementById("memberMenu");
  menu.style.display = menu.style.display === "none" ? "block" : "none";
  document.addEventListener("click", hideMemberMenuOutside, { once: true });
}

function hideMemberMenuOutside(e) {
  if (!e.target.closest('.dropdown')) {
    document.getElementById("memberMenu").style.display = "none";
  }
}

function openAddMember() {
  document.getElementById("popupOverlay").style.display = "flex";
  document.getElementById("memberMenu").style.display = "none";
}

function openManageMember() {
  document.getElementById("manageMemberOverlay").style.display = "flex";
  loadManageMemberList();
}

function closeManageMember() {
  document.getElementById("manageMemberOverlay").style.display = "none";
}

document.addEventListener("DOMContentLoaded", () => {
  const searchBox = document.getElementById("searchMemberManage");
  if (searchBox) {
    searchBox.addEventListener("input", e => {
      loadManageMemberList(e.target.value.toLowerCase());
    });
  }
});

async function loadManageMemberList(query = "") {
  const container = document.getElementById("manageMemberList");
  if (!container) return;

  container.innerHTML = "";

  const snap = await db.collection("members").orderBy("name").get();
  snap.forEach(doc => {
    const data = doc.data();
    if (!query || data.name.toLowerCase().includes(query)) {
      const div = document.createElement("div");
      div.style = "display:flex; justify-content:space-between; align-items:center; padding:8px 0; border-bottom:1px solid #eee;";
      div.innerHTML = `
        <span>${data.name}</span>
        <span>
          <button onclick="editPlayer('${doc.id}')">Edit</button>
          <button onclick="deletePlayer('${doc.id}', '${data.name}')">Delete</button>
        </span>
      `;
      container.appendChild(div);
    }
  });
}

function toggleMemberMenu() {
  const menu = document.getElementById("memberMenu");
  menu.style.display = (menu.style.display === "none" || menu.style.display === "") ? "block" : "none";
}

function closeMemberMenu() {
  const menu = document.getElementById("memberMenu");
  menu.style.display = "none";
}


async function buildMemberNameMap() {
  const snap = await db.collection("members").get();
  const map = new Map();
  snap.forEach(doc => {
    const data = doc.data();
    map.set(doc.id, data.name || "Unknown");
  });
  return map;
}

function loadGameHistory() {
  document.getElementById("historySearchBox").style.display = "block";
  document.getElementById("historyContainer").innerHTML = "";
}

function presetHistoryDays(days) {
  const today = new Date();
  const past = new Date();
  past.setDate(today.getDate() - days);

  document.getElementById("historyStartDate").value = past.toISOString().slice(0, 10);
  document.getElementById("historyEndDate").value = today.toISOString().slice(0, 10);

  searchGameHistory();
}

async function searchGameHistory(showAll = false) {
  const container = document.getElementById("historyContainer");
  container.innerHTML = "<h2>üìú ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏Å‡∏°‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å Break</h2>";

  let startTime = null;
  let endTime = null;

  if (!showAll) {
    const start = document.getElementById("historyStartDate").value;
    const end = document.getElementById("historyEndDate").value;

    if (!start || !end) {
      container.innerHTML += "<p style='color:red;'>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö</p>";
      return;
    }

    startTime = new Date(start).getTime();
    endTime = new Date(end + "T23:59:59").getTime();
  }

  const snapshot = await db.collection("games")
    .where("status", "==", "Game Break")
    .orderBy("createdAt", "desc")
    .get();

  const filteredDocs = showAll
    ? snapshot.docs
    : snapshot.docs.filter(doc => {
        const ts = doc.data().createdAt?.seconds * 1000 || 0;
        return ts >= startTime && ts <= endTime;
      });

  if (filteredDocs.length === 0) {
    container.innerHTML += "<p>‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏Å‡∏°‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏î‡∏±‡∏á‡∏Å‡∏•‡πà‡∏≤‡∏ß</p>";
    return;
  }

  for (const doc of filteredDocs) {
    const data = doc.data();
    const created = new Date(data.createdAt.seconds * 1000).toLocaleString();
    const gameId = data.id;

    const sitoutSnap = await db.collection("games").doc(gameId).collection("sitout").get();
    let sumBuyin = 0;
    let sumCashout = 0;

    const playerHTML = [];

    sitoutSnap.forEach(playerDoc => {
      const p = playerDoc.data();
      const buyin = Array.isArray(p.buyins)
        ? p.buyins.reduce((sum, b) => sum + (b.amount || 0), 0)
        : (p.buyin || 0);
      const cashout = p.cashout || 0;
      const profit = p.total || (cashout - buyin);

      sumBuyin += buyin;
      sumCashout += cashout;

      playerHTML.push(`
  <div style="display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px dashed #ddd;">
    <div style="flex: 1;">${p.name}</div>
    <div style="width: 100px; text-align: right;">Buy-in: ${buyin}</div>
    <div style="width: 120px; text-align: right;">Cash-out: ${cashout}</div>
    <div style="width: 100px; text-align: right; color: ${profit >= 0 ? 'green' : 'red'};">Profit: ${profit}</div>
  </div>
`);
});

const profitColor = (sumCashout - sumBuyin) >= 0 ? 'green' : 'red';

gameDiv.innerHTML = `
  <div style="font-size: 16px; font-weight: bold; margin-bottom: 10px;">
    üïí ${created} - <span style="color:gray;">Game Break</span>
  </div>

  <div style="margin-bottom: 10px;">
    <span style="margin-right: 20px;"><strong>üí∞ Buy-in ‡∏£‡∏ß‡∏°:</strong> ${sumBuyin}</span>
    <span style="margin-right: 20px;"><strong>üè¶ Cash-out ‡∏£‡∏ß‡∏°:</strong> ${sumCashout}</span>
    <span><strong>üìà Profit ‡∏£‡∏ß‡∏°:</strong> <span style="color:${profitColor};">${sumCashout - sumBuyin}</span></span>
  </div>

  <table style="width: 100%; border-collapse: collapse; border: 1px solid #ccc;">
    <thead>
      <tr style="background-color: #f2f2f2;">
        <th style="padding: 8px; text-align: left;">‡∏ä‡∏∑‡πà‡∏≠</th>
        <th style="padding: 8px; text-align: right;">Buy-in</th>
        <th style="padding: 8px; text-align: right;">Cash-out</th>
        <th style="padding: 8px; text-align: right;">Profit</th>
      </tr>
    </thead>
    <tbody>
      ${playerHTML.join("")}
    </tbody>
  </table>
`;
}
}

async function searchGameHistory(showAll = false) {
  const container = document.getElementById("historyContainer");
  container.innerHTML = "<h2>üìú ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏Å‡∏°‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å Break</h2>";

  let startTime = null;
  let endTime = null;

  if (!showAll) {
    const start = document.getElementById("historyStartDate").value;
    const end = document.getElementById("historyEndDate").value;

    if (!start || !end) {
      container.innerHTML += "<p style='color:red;'>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö</p>";
      return;
    }

    startTime = new Date(start).getTime();
    endTime = new Date(end + "T23:59:59").getTime();
  }

  const snapshot = await db.collection("games")
    .where("status", "==", "Game Break")
    .orderBy("createdAt", "desc")
    .get();

  const filteredDocs = showAll
    ? snapshot.docs
    : snapshot.docs.filter(doc => {
        const ts = doc.data().createdAt?.seconds * 1000 || 0;
        return ts >= startTime && ts <= endTime;
      });

  if (filteredDocs.length === 0) {
    container.innerHTML += "<p>‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏Å‡∏°‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏î‡∏±‡∏á‡∏Å‡∏•‡πà‡∏≤‡∏ß</p>";
    return;
  }

  for (const doc of filteredDocs) {
    const data = doc.data();
    const created = new Date(data.createdAt.seconds * 1000).toLocaleString();
    const gameId = data.id;

    const sitoutSnap = await db.collection("games").doc(gameId).collection("sitout").get();
    let sumBuyin = 0;
    let sumCashout = 0;

    const playerHTML = [];

    sitoutSnap.forEach(playerDoc => {
      const p = playerDoc.data();
      const buyin = Array.isArray(p.buyins)
        ? p.buyins.reduce((sum, b) => sum + (b.amount || 0), 0)
        : (p.buyin || 0);
      const cashout = p.cashout || 0;
      const profit = p.total || (cashout - buyin);

      sumBuyin += buyin;
      sumCashout += cashout;

  playerHTML.push(`
  <tr>
    <td style="padding: 6px;">${p.name}</td>
    <td style="padding: 6px; text-align: right;">${buyin}</td>
    <td style="padding: 6px; text-align: right;">${cashout}</td>
    <td style="padding: 6px; text-align: right; color: ${profit >= 0 ? 'green' : 'red'};">${profit}</td>
  </tr>
`);

    });

const gameDiv = document.createElement("div");
gameDiv.style = "margin-bottom: 20px; padding: 10px; border: 1px solid #ccc; border-radius: 8px;";

const profitColor = (sumCashout - sumBuyin) >= 0 ? 'green' : 'red';

gameDiv.innerHTML = `
  <div style="font-size: 16px; font-weight: bold; margin-bottom: 10px;">
    üïí ${created} - <span style="color:gray;">Game Break</span>
  </div>

  <div style="margin-bottom: 10px;">
    <span style="margin-right: 20px;"><strong>üí∞ Buy-in ‡∏£‡∏ß‡∏°:</strong> ${sumBuyin}</span>
    <span style="margin-right: 20px;"><strong>üè¶ Cash-out ‡∏£‡∏ß‡∏°:</strong> ${sumCashout}</span>
    <span><strong>üìà Profit ‡∏£‡∏ß‡∏°:</strong> <span style="color:${profitColor};">${sumCashout - sumBuyin}</span></span>
  </div>

  <table style="width: 100%; border-collapse: collapse; border: 1px solid #ccc; margin-top: 10px;">
    <thead>
      <tr style="background: #f5f5f5;">
        <th style="text-align: left; padding: 8px;">‡∏ä‡∏∑‡πà‡∏≠</th>
        <th style="text-align: right; padding: 8px;">Buy-in</th>
        <th style="text-align: right; padding: 8px;">Cash-out</th>
        <th style="text-align: right; padding: 8px;">Profit</th>
      </tr>
    </thead>
    <tbody>
      ${playerHTML.join("")}
    </tbody>
  </table>
`;
container.appendChild(gameDiv);

  }
}


</script>

</body>
</html>